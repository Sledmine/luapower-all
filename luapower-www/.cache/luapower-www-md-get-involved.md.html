<h2 id="anatomy-of-a-package">Anatomy of a package</h2>
<p>There are 6 types of luapower packages:</p>
<ul>
<li><strong>Lua module</strong>: written in Lua</li>
<li><strong>Terra module</strong>: written in Terra</li>
<li><strong>Lua/C module</strong>: written in C using the Lua C API (*)</li>
<li><strong>Lua+ffi module</strong>: written in Lua using the LuaJIT ffi extension (*)</li>
<li><strong>C module</strong>: binary dependency or support library for other module (*)</li>
<li><strong>other</strong>: none of the above: media/support files, etc.</li>
</ul>
<p>(*) binaries and C source code included.</p>
<p>NOTE: modules that only work in an OpenResty environment are typed “Resty” even though the language is Lua.</p>
<h3 id="tldr-template-packages">TL;dr: Template packages</h3>
<ul>
<li><a href="https://github.com/luapower/template-lua">Lua module</a></li>
<li><a href="https://github.com/luapower/template-lua-ffi">Lua+ffi module</a></li>
</ul>
<h3 id="directory-layout">Directory layout</h3>
<p><strong>NEW:</strong> You can now <a href="/tree">browse the whole source tree</a> online where each file and directory is described!</p>
<pre><code>foo.lua               main module
foo_bar.lua           submodule, for small packages
foo/bar.lua           submodule, for large packages
foo_h.lua             ffi.cdef module (ffi.load is in foo.lua, not here)
foo_test.lua          test program: for tests that can be automated
foo_demo.lua          demo program: anything goes
foo.md                main doc: markdown with pandoc extensions
foo_bar.md            submodule doc: optional, for large submodules
.mgit/foo.exclude     the .gitignore file: optional, see below</code></pre>
<p>C libs must also include their source code, build scripts and binaries:</p>
<pre><code>csrc/foo/*                           C sources
csrc/foo/WHAT                        WHAT file (see below)
csrc/foo/build-&lt;platform&gt;.sh         build scripts
bin/&lt;platform&gt;/*.dll|.so|.dylib|.a   binaries</code></pre>
<p>These conventions allow packages to be safely unzipped over a common directory and the result look sane, and it makes it possible to extract package information and build the package database and this website.</p>
<h3 id="the-docs">The docs</h3>
<p>In order to appear on the website, docs should start with a yaml header:</p>
<pre><code>---
tagline: foobars
platforms: linx64, mingw64
license: MIT
---</code></pre>
<p>Take your time to write a good, short tagline. This is important for figuring out what the module does when browsing the module list.</p>
<p>The <code>platforms</code> line is only needed for Lua packages that are platform-specific but do not have a C component (very rare case). In all other cases, do not specify the platforms.</p>
<p>The <code>license</code> line is only if needed for Lua modules that are not <code>Public Domain</code>.</p>
<p>You don’t have to make a doc for each submodule if you don’t have much to document for it, a single doc matching the package name would suffice.</p>
<h3 id="the-what-file">The WHAT file</h3>
<p>The WHAT file is for packages that have a C component (i.e. Lua/C, C and Lua+ffi packages that bind on 3rd-party libs), and it’s used to describe that C component (pure Lua packages don’t need a WHAT file). It should look like this:</p>
<pre><code>cairo 1.12.16 from http://cairographics.org/releases/ (MPL/LGPL license)
requires: pixman, freetype, zlib, libpng</code></pre>
<p>The first line should contain “<code>&lt;name&gt; &lt;version&gt; from &lt;browse-url&gt; (&lt;license&gt;)</code>”. The second line should contain “<code>requires: package1, package2, ...</code>” and should only list the binary dependencies of the library, if there are any. After the first two lines and an empty line, you can type in additional notes, whatever, they aren’t parsed. In the rare case that a dependency is only available on some platforms, specify the platforms after the dependency name like this: <code>pthread (linux64 mingw64)</code>.</p>
<p>The WHAT file can also be used to describe Lua modules that are developed outside of luapower (eg. <a href="/lexer">lexer</a>).</p>
<h3 id="the-exclude-file">The exclude file</h3>
<p><strong>NOTE:</strong> This file is entirely optional and rarely used.</p>
<p>This is the .gitignore file used for excluding files between packages so that files in one packages don’t show as untracked files in other package. Another way to think of it is the file used for reserving name-space in the luapower directory layout.</p>
<p>Example:</p>
<pre><code>*                    ; exclude all files
!/foo*               ; include files in root that start with `foo`
!/foo/               ; include the directory in root named `foo`
!/foo/**             ; include the contents of the directory named `foo`, recursively</code></pre>
<h3 id="the-code">The code</h3>
<p>Check out the info on <a href="/coding-style">coding style</a>.</p>
<h3 id="the-build-scripts">The build scripts</h3>
<p>Check out the info on <a href="/build-scripts">build scripts</a>.</p>
<h3 id="the-license">The License</h3>
<p><strong>NOTE:</strong> This only concerns Lua modules that are <em>not in Public Domain</em>.</p>
<ul>
<li>add <code>license: ...</code> to the header of your main doc</li>
<li>put the full license file in csrc/foo/LICENSE|COPYING[.*]</li>
<li>the default license in absence of a license tag is Public Domain.</li>
</ul>
<h3 id="versioning">Versioning</h3>
<p>All modules should work together from the master branch at any time. Each package has to keep up with the others. If you introduce breaking changes on a package, you have to upgrade all its dependants immediately. Work on a dev branch until you do so.</p>
<p>Conventions that I follow (you can of course use semantic versioning too):</p>
<ul>
<li>tag everything with just the major version (i.e. start with <code>mgit tag foo r1</code>)</li>
<li>increment the tag on breaking changes (i.e. <code>mgit foo bump</code>)</li>
</ul>
<h2 id="publishing-packages-on-luapower.com">Publishing packages on luapower.com</h2>
<blockquote>
<p>Refer to <a href="/luapower-git">luapower-git</a> for the actual procedure.</p>
</blockquote>
<p>Before publishing a luapower module, please consider:</p>
<ul>
<li>what name you plan to use for your module</li>
<li>how your module relates to other modules</li>
</ul>
<p>Choosing a good name is important if you want people to find your module and understand (from the name alone) what it does. Likewise, it’s a good idea to be sure that your module is doing something new or at least different (and hopefully better) than something already on luapower.com.</p>
<p>Ideally, your module has:</p>
<ul>
<li><strong>distinction</strong> - focused problem domain</li>
<li><strong>completeness</strong> - exhaustive of the problem domain</li>
<li><strong>API documentation</strong> - so it can be browsed online</li>
<li><strong>test and/or demo</strong> - so it can be seen to work</li>
<li><strong>a non-viral license</strong> - so it doesn’t impose restrictions on <em>other</em> modules</li>
</ul>
<p>Of course, few modules (in any language) qualify on all fronts, so luapower.com is necessarily an eclectic mix. In any case, if your module collection is too specialized to be added to luapower.com or you simply don’t want to mix it in with the others, remember that you can always fork <a href="/luapower-repos">luapower-repos</a> and make your own module collections. And ultimately, you can fork the website too.</p>
<h2 id="forking-luapower.com">Forking luapower.com</h2>
<p>The luapower website is composed of:</p>
<ul>
<li><a href="/luapower-repos">luapower-repos</a>, a meta repository which contains the list of packages to be cloned with multigit.</li>
<li><a href="/luapower">luapower</a>, a Lua module for collecting package metadata.</li>
<li><a href="https://github.com/luapower/website">website</a>, an <a href="http://openresty.org">open-resty</a>-based app, with very simple css, mustache-based templates and table-based layout.</li>
<li><a href="http://johnmacfarlane.net/pandoc/">pandoc</a>, for converting the docs to html.</li>
<li>a bunch of Windows, Linux and OSX machines set up to collect package dependency information and run automated tests.</li>
</ul>
<p>If you want to put this together but get stuck on the details, ask away on the <a href="/forum">forum</a>, we’ll help you seeing it through.</p>
