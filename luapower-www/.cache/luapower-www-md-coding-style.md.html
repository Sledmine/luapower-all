<p><strong>NOTE</strong>: This guide assumes familiarity with the <a href="http://lua-users.org/wiki/LuaStyleGuide">LuaStyleGuide</a> from the Lua wiki. Read that first if you’re new to Lua.</p>
<h2 id="general">General</h2>
<p>Start each module with small comment specifying what the module does, who’s the author and what the license is:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode lua"><code class="sourceCode lua"><span id="cb1-1"><a href="#cb1-1"></a></span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="co">--glue: everyday Lua functions.</span></span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="co">--Written by Cosmin Apreutesei. Public domain.</span></span>
<span id="cb1-4"><a href="#cb1-4"></a></span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="op">...</span></span></code></pre></div>
<p>Don’t embed the full contents of the license in the source code.</p>
<h2 id="formatting">Formatting</h2>
<p>Indent code with tabs, and use spaces inside the line, don’t force your tab size on people (also, very few editors can jump through space indents). If you can’t follow this, use 3 spaces for Lua and 4 spaces for C.</p>
<p>Keep lines under 80 chars as much as you reasonably can.</p>
<p>Tell your editor to remove trailing spaces and to keep an empty line at EOF.</p>
<p>Use <code>\r\n</code> as line separator only for Windows-specific modules, if at all. Generally just use <code>\n</code>.</p>
<h2 id="modules">Modules</h2>
<p>Keep Mr. _G clean, don’t use <code>module()</code>. Use one of these patterns instead:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode lua"><code class="sourceCode lua"><span id="cb2-1"><a href="#cb2-1"></a><span class="kw">local</span> <span class="cn">M</span> <span class="op">=</span> <span class="op">{}</span></span>
<span id="cb2-2"><a href="#cb2-2"></a></span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="kw">function</span> <span class="cn">M</span><span class="op">.</span>foo<span class="op">()</span></span>
<span id="cb2-4"><a href="#cb2-4"></a>   <span class="op">...</span></span>
<span id="cb2-5"><a href="#cb2-5"></a><span class="cf">end</span></span>
<span id="cb2-6"><a href="#cb2-6"></a></span>
<span id="cb2-7"><a href="#cb2-7"></a><span class="kw">function</span> <span class="cn">M</span><span class="op">.</span>bar<span class="op">()</span></span>
<span id="cb2-8"><a href="#cb2-8"></a>   <span class="op">...</span></span>
<span id="cb2-9"><a href="#cb2-9"></a><span class="cf">end</span></span>
<span id="cb2-10"><a href="#cb2-10"></a></span>
<span id="cb2-11"><a href="#cb2-11"></a><span class="cf">return</span> <span class="cn">M</span></span></code></pre></div>
<p>or:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode lua"><code class="sourceCode lua"><span id="cb3-1"><a href="#cb3-1"></a><span class="kw">local</span> <span class="kw">function</span> foo<span class="op">()</span></span>
<span id="cb3-2"><a href="#cb3-2"></a>   <span class="op">...</span></span>
<span id="cb3-3"><a href="#cb3-3"></a><span class="cf">end</span></span>
<span id="cb3-4"><a href="#cb3-4"></a></span>
<span id="cb3-5"><a href="#cb3-5"></a><span class="kw">local</span> <span class="kw">function</span> bar<span class="op">()</span></span>
<span id="cb3-6"><a href="#cb3-6"></a>   <span class="op">...</span></span>
<span id="cb3-7"><a href="#cb3-7"></a><span class="cf">end</span></span>
<span id="cb3-8"><a href="#cb3-8"></a></span>
<span id="cb3-9"><a href="#cb3-9"></a><span class="cf">return</span> <span class="op">{</span></span>
<span id="cb3-10"><a href="#cb3-10"></a>   foo <span class="op">=</span> foo<span class="op">,</span></span>
<span id="cb3-11"><a href="#cb3-11"></a>   bar <span class="op">=</span> bar<span class="op">,</span></span>
<span id="cb3-12"><a href="#cb3-12"></a><span class="op">}</span></span></code></pre></div>
<h2 id="submodules">Submodules</h2>
<p>Split optional functionality into submodules. Submodules can either have their own namespace or can extend the main module’s namespace.</p>
<p>Name submodules of <code>foo</code> <code>foo_bar.lua</code> instead of <code>foo/bar.lua</code>.</p>
<p>Submodules can be loaded manually by the user with require() or they can be set up to be loaded automatically with <a href="/glue#autoload">glue.autoload</a>.</p>
<h2 id="naming">Naming</h2>
<p>Take time to find good names and take time to <em>re-factor those names</em> as much as necessary. As a wise stackoverflow user once said, the process of naming makes you face the horrible fact that you have no idea what the hell you’re doing.</p>
<p>Use Lua’s naming conventions <code>foo_bar</code> and <code>foobar</code> instead of <code>FooBar</code> or <code>fooBar</code>.</p>
<h3 id="temporary-variables">Temporary variables</h3>
<ul>
<li><code>t</code> is for tables</li>
<li><code>dt</code> is for destination (accumulation) tables (and for time diffs)</li>
<li><code>i</code> and <code>j</code> are for indexing</li>
<li><code>n</code> is for counting</li>
<li><code>k, v</code> is what you get out of pairs()</li>
<li><code>i, v</code> is what you get out of ipairs()</li>
<li><code>k</code> is for table keys</li>
<li><code>v</code> is for values that are passed around</li>
<li><code>x</code> is for generic math quantities</li>
<li><code>s</code> is for strings</li>
<li><code>c</code> is for 1-char strings</li>
<li><code>f</code> and <code>func</code> are for functions</li>
<li><code>o</code> is for objects</li>
<li><code>ret</code> is for return values</li>
<li><code>ok, ret</code> is what you get out of <code>pcall</code></li>
<li><code>buf, sz</code> is a (buffer, size) pair</li>
<li><code>p</code> is for pointers</li>
<li><code>x, y, w, h</code> is for rectangles</li>
<li><code>t0</code>, <code>t1</code> is for timestamps</li>
<li><code>err</code> is for errors</li>
<li><code>t0</code> or <code>t_</code> is for avoiding a name clash with <code>t</code></li>
</ul>
<h3 id="abbreviations">Abbreviations</h3>
<p>Abbreviations are ok, just don’t forget to document them when they first appear in the code. Short names are mnemonic and you can juggle more of them in your head at the same time, and they’re indicative of a deeply understood problem: you’re not being lazy for using them.</p>
<h2 id="comments">Comments</h2>
<p>Assume your readers already know Lua so try not to teach that to them (it would show that you’re really trying to teach it to yourself). But don’t tell them that the code “speaks for itself” either because it doesn’t. Take time to document the tricky parts of the code. If there’s an underlying narrative on how you solved a problem, take time to document that too. Don’t worry about how long that is, people love stories. And in fact the high-level overview, how everything is put together is <em>much more important</em> than the nitty-gritty details and it’s too often missing.</p>
<h2 id="syntax">Syntax</h2>
<ul>
<li>use <code>foo()</code> instead of <code>foo ()</code></li>
<li>use <code>foo{}</code> instead of <code>foo({})</code> (there’s no font to save you from that)</li>
<li>use <code>foo'bar'</code> instead of <code>foo"bar"</code>, <code>foo "bar"</code> or <code>foo("bar")</code></li>
<li>use <code>foo.bar</code> instead of <code>foo['bar']</code></li>
<li>use <code>local function foo() end</code> instead of <code>local foo = function() end</code> (this sugar shouldn’t have existed, but it’s too late now)</li>
<li>put a comma after the last element of vertical lists</li>
</ul>
<h2 id="ffi-declarations">FFI Declarations</h2>
<p>Put cdefs in a separate <code>foo_h.lua</code> file because it may contain types that other packages might need. If this is unlikely and the API is small, embed the cdefs in the main module file directly.</p>
<p>Add a comment on top of your <code>foo_h.lua</code> file describing the origin (which files? which version?) and process (cpp? by hand?) used for generating the file. This adds confidence that the C API is complete and up-to-date and can hint a maintainer on how to upgrade the definitions.</p>
<p>Call <code>ffi.load()</code> without paths, custom names or version numbers to keep the module away from any decisions regarding how and where the library is to be found. This allows for more freedom on how to deploy libraries.</p>
<h2 id="code-patterns">Code patterns</h2>
<p>Sometimes the drive to compress and compact the code goes against clarity, obscuring the programmer’s intention. Here’s a few patterns of code that can be improved in that regard:</p>
<table>
<colgroup>
<col style="width: 27%" />
<col style="width: 36%" />
<col style="width: 36%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: left;"><strong>Intention</strong></td>
<td style="text-align: left;"><strong>Unclear way</strong></td>
<td style="text-align: left;"><strong>Better way</strong></td>
</tr>
<tr class="even">
<td style="text-align: left;">break the code</td>
<td style="text-align: left;"><code>return last_func_call()</code></td>
<td style="text-align: left;"><code>last_func_call()</code><br />
<code>return</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;">declaring unrelated variables</td>
<td style="text-align: left;"><code>local var1, var2 = val1, val2</code></td>
<td style="text-align: left;"><code>local var1 = val1</code><br />
<code>local var2 = val2</code></td>
</tr>
<tr class="even">
<td style="text-align: left;">private methods</td>
<td style="text-align: left;"><code>local function foo(self, ...) end</code><br />
<code>foo(self, ...)</code></td>
<td style="text-align: left;"><code>function obj:_foo(...) end</code><br />
<code>self:_foo(...)</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;">dealing with simple cases</td>
<td style="text-align: left;"><code>if simple_case then</code><br />
  <code>return simple_answer</code><br />
<code>else</code><br />
  <code>hard case ...</code><br />
<code>end</code></td>
<td style="text-align: left;"><code>if simple_case then</code><br />
  <code>return simple_answer</code><br />
<code>end</code><br />
<code>hard case ...</code></td>
</tr>
<tr class="even">
<td style="text-align: left;">emulating bool()</td>
<td style="text-align: left;"><code>not not x</code></td>
<td style="text-align: left;"><code>x and true or false</code></td>
</tr>
</tbody>
</table>
<h2 id="strict-mode">Strict mode</h2>
<p>Use <code>require'strict'</code> when developing, but make sure to <strong>remove it</strong> before publishing your code to avoid breaking other people’s code.</p>
