<h2 id="local-rsync-requirersync"><code>local rsync = require'rsync'</code></h2>
<p>The <a href="https://rsync.samba.org/tech_report/">RSYNC algorithm</a> in Lua.</p>
<p>This library can be used to synchronize similar-but-not-identical files between two machines with little bandwidth costs. This implementation is CPU-bound on Gigabit networks even with a good CPU.</p>
<h2 id="api">API</h2>
<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: left;"><strong>stream-based API</strong></td>
<td></td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>rsync:gen_sigs_file(read, write [, block_len]) -&gt; sig_count</code></td>
<td>compute and save block signatures</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>rsync:load_sigs_file(read) -&gt; sigs</code></td>
<td>load block signatures</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>rsync:gen_deltas_file(read, sigs, write[, block_len]) -&gt; false_alarms</code></td>
<td>compute and save file differences</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>rsync:patch_file(read_delta, seek, read, write[, block_len])</code></td>
<td>patch original file with file differences</td>
</tr>
<tr class="even">
<td style="text-align: left;"><strong>config</strong></td>
<td></td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>rsync:new([config]) -&gt; rsync</code></td>
<td>new rsync module with optional overrides</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>rsync.block_len</code></td>
<td>default block length (1024)f_at</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>rsync.mem_len</code></td>
<td>default buffer length (64K)</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>rsync:weak_sum() -&gt; sum</code></td>
<td>create a weak sum digest (default is rolling sum in Lua)</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>rsync:strong_sum() -&gt; sum</code></td>
<td>create a strong sum digest (default is <a href="/blake2">blake2.blake2sp_digest</a>)</td>
</tr>
</tbody>
</table>
<p>The file functions operate on abstract read and write functions:</p>
<ul>
<li><code>read(buf, len) -&gt; read_len</code> assumed to read at most <code>len</code> bytes into <code>buf</code>, returns 0 to signal EOF, raises errors on failure.</li>
<li><code>write(buf, len)</code> assumed to always write exactly <code>len</code> bytes from <code>buf</code>. should raise an error otherwise.</li>
</ul>
<p>Callbacks are not allowed to yield but they can use <a href="/coro">coro</a> for control inversion.</p>
<h2 id="howto">HOWTO</h2>
<p>To update file1 on machine1 from the updated file1 on machine2,</p>
<ul>
<li>First call <code>rsync:gen_sigs_file()</code> on machine1 with a <code>read</code> function that reads file1 and with a <code>write</code> function that sends its bytes to machine2.</li>
<li>On machine2 call <code>rsync:load_sigs_file()</code> with a <code>read</code> function that reads the bytes sent through the network from machine1.</li>
<li>Then (still on machine2) call <code>rsync:gen_deltas_file()</code> with the signatures got from the previous step and a <code>read</code> function that reads file1 and a <code>write</code> function that sends its bytes to machine1.</li>
<li>Finally on machine1, call <code>rsync:patch_file()</code> with a <code>read_delta</code> function that reads the bytes sent through the network from machine1, a <code>seek(offset)</code> function that seeks in file1, a <code>read</code> function that reads from file1, and a <code>write</code> function that writes the resulting bytes to a new file. The optional arg <code>block_len</code>, if given, should be identical on all calls.</li>
</ul>
