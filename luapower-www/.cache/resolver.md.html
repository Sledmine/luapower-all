<h2 id="local-resolver-requireresolver"><code>local resolver = require'resolver'</code></h2>
<p>DNS resolver in Lua <a href="https://github.com/openresty/lua-resty-dns">from OpenResty</a> (BSD License). Modified to work with any LuaSocket-like API, including <a href="/socketloop">socketloop</a>.</p>
<h2 id="api">API</h2>
<table>
<tbody>
<tr class="odd">
<td style="text-align: left;"><code>resolver.new(opts) -&gt; r, err</code></td>
<td>create a resolver object</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>r:query(name, [options], [tries]) -&gt; answers, err, tries</code></td>
<td>query DNS</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>r:tcp_query(name, [options]) -&gt; answers, err</code></td>
<td>query DNS via TCP</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>r:set_timeout(time)</code></td>
<td>set timeout</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>resolver.arpa_str(address) -&gt; arpa_record</code></td>
<td></td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>r:reverse_query(address) -&gt; answers, err</code></td>
<td></td>
</tr>
</tbody>
</table>
<p>IMPORTANT: to be able generate unique ids, the random generator must be properly seeded using <code>math.randomseed</code> prior to using this module.</p>
<h2 id="example">Example</h2>
<div class="sourceCode" id="cb1"><pre class="sourceCode lua"><code class="sourceCode lua"><span id="cb1-1"><a href="#cb1-1"></a><span class="kw">local</span> r<span class="op">,</span> err <span class="op">=</span> <span class="fu">assert</span><span class="op">(</span>resolver<span class="op">.</span>new<span class="op">{</span></span>
<span id="cb1-2"><a href="#cb1-2"></a>   nameservers <span class="op">=</span> <span class="op">{</span><span class="st">&#39;8.8.8.8&#39;</span><span class="op">,</span> <span class="op">{</span><span class="st">&#39;8.8.4.4&#39;</span><span class="op">,</span> <span class="dv">53</span><span class="op">}</span> <span class="op">},</span></span>
<span id="cb1-3"><a href="#cb1-3"></a>   retrans <span class="op">=</span> <span class="dv">5</span><span class="op">,</span>  <span class="co">-- 5 retransmissions on receive timeout</span></span>
<span id="cb1-4"><a href="#cb1-4"></a>   timeout <span class="op">=</span> <span class="dv">2000</span><span class="op">,</span>  <span class="co">-- 2 sec</span></span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="op">})</span></span>
<span id="cb1-6"><a href="#cb1-6"></a><span class="kw">local</span> answers<span class="op">,</span> err<span class="op">,</span> tries <span class="op">=</span> r<span class="op">:</span>query<span class="op">(</span><span class="st">&#39;www.google.com&#39;</span><span class="op">,</span> <span class="kw">nil</span><span class="op">,</span> <span class="op">{})</span></span>
<span id="cb1-7"><a href="#cb1-7"></a><span class="cf">if</span> <span class="kw">not</span> answers <span class="cf">then</span></span>
<span id="cb1-8"><a href="#cb1-8"></a>    <span class="fu">print</span><span class="op">(</span><span class="st">&#39;failed to query the DNS server: &#39;</span> <span class="op">..</span> err<span class="op">)</span></span>
<span id="cb1-9"><a href="#cb1-9"></a>    <span class="fu">print</span><span class="op">(</span><span class="st">&#39;retries: &#39;</span> <span class="op">..</span> <span class="fu">table.concat</span><span class="op">(</span>tries<span class="op">,</span> <span class="st">&#39;</span><span class="sc">\n</span><span class="st">&#39;</span><span class="op">))</span></span>
<span id="cb1-10"><a href="#cb1-10"></a><span class="cf">elseif</span> answers<span class="op">.</span>errcode <span class="cf">then</span></span>
<span id="cb1-11"><a href="#cb1-11"></a>    <span class="fu">print</span><span class="op">(</span><span class="st">&#39;server returned error code: &#39;</span> <span class="op">..</span></span>
<span id="cb1-12"><a href="#cb1-12"></a>      answers<span class="op">.</span>errcode <span class="op">..</span> <span class="st">&#39;: &#39;</span> <span class="op">..</span> answers<span class="op">.</span>errstr<span class="op">)</span></span>
<span id="cb1-13"><a href="#cb1-13"></a><span class="cf">end</span></span>
<span id="cb1-14"><a href="#cb1-14"></a><span class="cf">for</span> i<span class="op">,</span> ans <span class="kw">in</span> <span class="fu">ipairs</span><span class="op">(</span>answers<span class="op">)</span> <span class="cf">do</span></span>
<span id="cb1-15"><a href="#cb1-15"></a>    <span class="fu">print</span><span class="op">(</span>ans<span class="op">.</span>name <span class="op">..</span> <span class="st">&#39; &#39;</span> <span class="op">..</span> <span class="op">(</span>ans<span class="op">.</span>address <span class="kw">or</span> ans<span class="op">.</span>cname<span class="op">)</span> <span class="op">..</span></span>
<span id="cb1-16"><a href="#cb1-16"></a>      <span class="st">&#39; type:&#39;</span> <span class="op">..</span> ans<span class="op">.</span>type <span class="op">..</span> <span class="st">&#39; class: &#39;</span> <span class="op">..</span> ans<span class="op">.</span>class <span class="op">..</span> <span class="st">&#39; ttl: &#39;</span> <span class="op">..</span> ans<span class="op">.</span>ttl<span class="op">)</span></span>
<span id="cb1-17"><a href="#cb1-17"></a><span class="cf">end</span></span></code></pre></div>
<h2 id="api-1">API</h2>
<h3 id="resolver.newopts---r-err"><code>resolver.new(opts) -&gt; r, err</code></h3>
<p>Creates a resolver object. Returns <code>nil</code> and an message string on error.</p>
<p>It accepts a <code>opts</code> table argument. The following options are supported:</p>
<ul>
<li><p><code>nameservers</code></p>
<p>a list of nameservers to be used. Each nameserver entry can be either a single hostname string or a table holding both the hostname string and the port number. The nameserver is picked up by a simple round-robin algorithm for each <code>query</code> method call. This option is required.</p></li>
<li><p><code>retrans</code></p>
<p>the total number of times of retransmitting the DNS request when receiving a DNS response times out according to the <code>timeout</code> setting. Defaults to <code>5</code> times. When trying to retransmit the query, the next nameserver according to the round-robin algorithm will be picked up.</p></li>
<li><p><code>timeout</code></p>
<p>the time in milliseconds for waiting for the respond for a single attempt of request transmition. note that this is ‘’not’’ the maximal total waiting time before giving up, the maximal total waiting time can be calculated by the expression <code>timeout x retrans</code>. The <code>timeout</code> setting can also be changed by calling the <code>set_timeout</code> method. The default <code>timeout</code> setting is 2000 milliseconds, or 2 seconds.</p></li>
<li><p><code>no_recurse</code></p>
<p>a boolean flag controls whether to disable the “recursion desired” (RD) flag in the UDP request. Defaults to <code>false</code>.</p></li>
<li><p><code>async</code></p>
<p>a boolean flag indicating that sockets shoud be wrapped by <a href="/socketloop">socketloop</a>.</p></li>
<li><p><code>tcp</code>, <code>udp</code>, <code>tcp_async</code>, <code>udp_async</code></p>
<p>alternative socket constructors, defaulting to <a href="/socket">socket</a> tcp and udp constructors. Can also be set at module level.</p></li>
</ul>
<h3 id="rqueryname-options-tries---answers-err-tries"><code>r:query(name, [options], [tries]) -&gt; answers, err, tries</code></h3>
<p>Perform a DNS standard query to the nameservers specified by the <code>new</code> method, and returns all the answer records in an array-like Lua table. In case of errors, it will return <code>nil</code> and a string describing the error instead.</p>
<p>If the server returns a non-zero error code, the fields <code>errcode</code> and <code>errstr</code> will be set accordingly in the Lua table returned.</p>
<p>Each entry in the <code>answers</code> returned table value is also a hash-like Lua table which usually takes some of the following fields:</p>
<ul>
<li><p><code>name</code></p>
<p>The resource record name.</p></li>
<li><p><code>type</code></p>
<p>The current resource record type, possible values are <code>1</code> (<code>TYPE_A</code>), <code>5</code> (<code>TYPE_CNAME</code>), <code>28</code> (<code>TYPE_AAAA</code>), and any other values allowed by RFC 1035.</p></li>
<li><p><code>address</code></p>
<p>The IPv4 or IPv6 address in their textual representations when the resource record type is either <code>1</code> (<code>TYPE_A</code>) or <code>28</code> (<code>TYPE_AAAA</code>), respectively. Secussesive 16-bit zero groups in IPv6 addresses will not be compressed by default, if you want that, you need to call the <code>compress_ipv6_addr</code> static method instead.</p></li>
<li><p><code>section</code></p>
<p>The identifier of the section that the current answer record belongs to. Possible values are <code>1</code> (<code>SECTION_AN</code>), <code>2</code> (<code>SECTION_NS</code>), and <code>3</code> (<code>SECTION_AR</code>).</p></li>
<li><p><code>cname</code></p>
<p>The (decoded) record data value for <code>CNAME</code> resource records. Only present for <code>CNAME</code> records.</p></li>
<li><p><code>ttl</code></p>
<p>The time-to-live (TTL) value in seconds for the current resource record.</p></li>
<li><p><code>class</code></p>
<p>The current resource record class, possible values are <code>1</code> (<code>CLASS_IN</code>) or any other values allowed by RFC 1035.</p></li>
<li><p><code>preference</code></p>
<p>The preference integer number for <code>MX</code> resource records. Only present for <code>MX</code> type records.</p></li>
<li><p><code>exchange</code></p>
<p>The exchange domain name for <code>MX</code> resource records. Only present for <code>MX</code> type records.</p></li>
<li><p><code>nsdname</code></p>
<p>A domain-name which specifies a host which should be authoritative for the specified class and domain. Usually present for <code>NS</code> type records.</p></li>
<li><p><code>rdata</code></p>
<p>The raw resource data (RDATA) for resource records that are not recognized.</p></li>
<li><p><code>txt</code></p>
<p>The record value for <code>TXT</code> records. When there is only one character string in this record, then this field takes a single Lua string. Otherwise this field takes a Lua table holding all the strings.</p></li>
<li><p><code>ptrdname</code></p>
<p>The record value for <code>PTR</code> records.</p></li>
</ul>
<p>This method also takes an optional <code>options</code> argument table, which takes the following fields:</p>
<ul>
<li><p><code>qtype</code></p>
<p>The type of the question. Possible values are <code>1</code> (<code>TYPE_A</code>), <code>5</code> (<code>TYPE_CNAME</code>), <code>28</code> (<code>TYPE_AAAA</code>), or any other QTYPE value specified by RFC 1035 and RFC 3596. Default to <code>1</code> (<code>TYPE_A</code>).</p></li>
<li><p><code>authority_section</code></p>
<p>When set to a true value, the <code>answers</code> return value includes the <code>Authority</code> section of the DNS response. Default to <code>false</code>.</p></li>
<li><p><code>additional_section</code></p>
<p>When set to a true value, the <code>answers</code> return value includes the <code>Additional</code> section of the DNS response. Default to <code>false</code>.</p></li>
</ul>
<p>The optional parameter <code>tries</code> can be provided as an empty table, and will be returned as a third result. The table will be an array with the error message for each (if any) failed try.</p>
<p>When data truncation happens, the resolver will automatically retry using the TCP transport mode to query the current nameserver. All TCP connections are short lived.</p>
<h3 id="rtcp_queryname-options---answers-err"><code>r:tcp_query(name, [options]) -&gt; answers, err</code></h3>
<p>Just like the <code>query</code> method, but enforce the TCP transport mode instead of UDP.</p>
<p>All TCP connections are short lived.</p>
<p>Here is an example:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode lua"><code class="sourceCode lua"><span id="cb2-1"><a href="#cb2-1"></a><span class="kw">local</span> r<span class="op">,</span> err <span class="op">=</span> <span class="fu">assert</span><span class="op">(</span>resolver<span class="op">.</span>new<span class="op">{</span></span>
<span id="cb2-2"><a href="#cb2-2"></a>   nameservers <span class="op">=</span> <span class="op">{</span> <span class="st">&#39;8.8.8.8&#39;</span> <span class="op">}</span></span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="op">})</span></span>
<span id="cb2-4"><a href="#cb2-4"></a><span class="kw">local</span> ans<span class="op">,</span> err <span class="op">=</span> r<span class="op">:</span>tcp_query<span class="op">(</span><span class="st">&#39;www.google.com&#39;</span><span class="op">,</span> <span class="op">{</span> qtype <span class="op">=</span> r<span class="op">.</span><span class="cn">TYPE_A</span> <span class="op">})</span></span>
<span id="cb2-5"><a href="#cb2-5"></a><span class="cf">if</span> <span class="kw">not</span> ans <span class="cf">then</span></span>
<span id="cb2-6"><a href="#cb2-6"></a>   <span class="fu">print</span><span class="op">(</span><span class="st">&#39;failed to query: &#39;</span> <span class="op">..</span> err<span class="op">)</span></span>
<span id="cb2-7"><a href="#cb2-7"></a>   <span class="cf">return</span></span>
<span id="cb2-8"><a href="#cb2-8"></a><span class="cf">end</span></span></code></pre></div>
<h3 id="rset_timeouttime"><code>r:set_timeout(time)</code></h3>
<p>Overrides the current <code>timeout</code> setting by the <code>time</code> argument in seconds for all the nameserver peers.</p>
<h3 id="resolver.arpa_straddress---arpa_record"><code>resolver.arpa_str(address) -&gt; arpa_record</code></h3>
<p>Generates the reverse domain name for PTR lookups for both IPv4 and IPv6 addresses. Compressed IPv6 addresses will be automatically expanded.</p>
<p>For example,</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode lua"><code class="sourceCode lua"><span id="cb3-1"><a href="#cb3-1"></a><span class="kw">local</span> ptr4 <span class="op">=</span> resolver<span class="op">.</span>arpa_str<span class="st">&#39;1.2.3.4&#39;</span></span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="kw">local</span> ptr6 <span class="op">=</span> resolver<span class="op">.</span>arpa_str<span class="st">&#39;FF01::101&#39;</span></span></code></pre></div>
<p>will yield <code>4.3.2.1.in-addr.arpa</code> for <code>ptr4</code> and <code>1.0.1.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.1.0.F.F.ip6.arpa</code> for <code>ptr6</code>.</p>
<h3 id="rreverse_queryaddress---answers-err"><code>r:reverse_query(address) -&gt; answers, err</code></h3>
<p>Performs a PTR lookup for both IPv4 and IPv6 addresses. This function is basically a wrapper for the <code>query</code> command which uses the <code>arpa_str</code> command to convert the IP address on the fly.</p>
<h3 id="constants">Constants</h3>
<table>
<tbody>
<tr class="odd">
<td style="text-align: left;"><code>r.TYPE_A</code></td>
<td style="text-align: left;">The <code>A</code> resource record type, equal to the decimal number <code>1</code>.</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>r.TYPE_NS</code></td>
<td style="text-align: left;">The <code>NS</code> resource record type, equal to the decimal number <code>2</code>.</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>r.TYPE_CNAME</code></td>
<td style="text-align: left;">The <code>CNAME</code> resource record type, equal to the decimal number <code>5</code>.</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>r.TYPE_SOA</code></td>
<td style="text-align: left;">The <code>SOA</code> resource record type, equal to the decimal number <code>6</code>.</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>r.TYPE_PTR</code></td>
<td style="text-align: left;">The <code>PTR</code> resource record type, equal to the decimal number <code>12</code>.</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>r.TYPE_MX</code></td>
<td style="text-align: left;">The <code>MX</code> resource record type, equal to the decimal number <code>15</code>.</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>r.TYPE_TXT</code></td>
<td style="text-align: left;">The <code>TXT</code> resource record type, equal to the decimal number <code>16</code>.</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>r.TYPE_AAAA</code></td>
<td style="text-align: left;">The <code>AAAA</code> resource record type, equal to the decimal number <code>28</code>.</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>r.TYPE_SRV</code></td>
<td style="text-align: left;">The <code>SRV</code> resource record type, equal to the decimal number <code>33</code>. See RFC 2782 for details.</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>r.TYPE_SPF</code></td>
<td style="text-align: left;">The <code>SPF</code> resource record type, equal to the decimal number <code>99</code>. See RFC 4408 for details.</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>r.CLASS_IN</code></td>
<td style="text-align: left;">The <code>Internet</code> resource record type, equal to the decimal number <code>1</code>.</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>r.SECTION_AN</code></td>
<td style="text-align: left;">Identifier of the <code>Answer</code> section in the DNS response. Equal to decimal number <code>1</code>.</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>r.SECTION_NS</code></td>
<td style="text-align: left;">Identifier of the <code>Authority</code> section in the DNS response. Equal to the decimal number <code>2</code>.</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>r.SECTION_AR</code></td>
<td style="text-align: left;">Idnetifier of the <code>Additional</code> section in the DNS response. Equal to the decimal number <code>3</code>.</td>
</tr>
</tbody>
</table>
<h2 id="todo">TODO</h2>
<ul>
<li>Concurrent (or parallel) query mode</li>
<li>Better support for other resource record types like <code>TLSA</code>.</li>
</ul>
