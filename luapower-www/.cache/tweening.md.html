<h2 id="local-tw-requiretweening"><code>local tw = require'tweening'</code></h2>
<p>A library for the management of gradual value changes for the purposes of animation, inspired by <a href="https://greensock.com/gsap">GSAP</a>.</p>
<h2 id="features">Features</h2>
<ul>
<li>timing parameters: <code>duration</code>, <code>speed</code>, <code>loop</code>, <code>backwards</code>, <code>yoyo</code>, <code>ease</code>, <code>way</code>, <code>offset</code>.</li>
<li>independent timing parameters for each target object and/or attribute.</li>
<li>timelines that can be nested, overlapping, and tweened.</li>
<li>stagger tweens: alternate end-values over a list of targets.</li>
<li>extensible attribute types, value converters and interpolation functions.</li>
<li>relative values including directional rotation.</li>
<li>pause/resume/restart/reverse individual tweens even when in a timeline.</li>
<li>no allocations while tweening.</li>
</ul>
<h2 id="tweens">Tweens</h2>
<h3 id="twtweent---tween"><code>tw:tween(t) -&gt; tween</code></h3>
<p>Create a new tween. A tween is an object which repeatedly updates a value on a target object <em>in time</em> based on an interpolation function and timing parameters.</p>
<p><strong>NOTE:</strong> <code>t</code> itself is turned into a tween (no new table is created). This allows any method to be overriden by specifying it directly as a field of <code>t</code>.</p>
<h3 id="timing-model">Timing model</h3>
<table>
<thead>
<tr class="header">
<th style="text-align: left;"><strong>field</strong></th>
<th style="text-align: left;"><strong>default</strong></th>
<th style="text-align: left;"><strong>description</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><code>start</code></td>
<td style="text-align: left;">current clock</td>
<td style="text-align: left;">start clock (relative when in a timeline)</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>duration</code></td>
<td style="text-align: left;"><code>1</code></td>
<td style="text-align: left;">duration of one iteration (can’t be negative)</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>ease</code></td>
<td style="text-align: left;"><code>'quad'</code></td>
<td style="text-align: left;">ease function <code>f(p) -&gt; d</code> or name from <a href="/easing">easing</a> module</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>way</code></td>
<td style="text-align: left;"><code>'in'</code></td>
<td style="text-align: left;">easing way: <code>'in'</code>, <code>'out'</code>, <code>'inout'</code> or <code>'outin'</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>ease_args</code></td>
<td style="text-align: left;">none</td>
<td style="text-align: left;">optional args to pass to the ease function</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>backwards</code></td>
<td style="text-align: left;"><code>false</code></td>
<td style="text-align: left;">start backwards</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>yoyo</code></td>
<td style="text-align: left;"><code>true</code></td>
<td style="text-align: left;">alternate between forwards and backwards on each iteration</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>loop</code></td>
<td style="text-align: left;"><code>1</code></td>
<td style="text-align: left;">number of iterations (can be fractional; use <code>1/0</code> for infinite)</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>speed</code></td>
<td style="text-align: left;"><code>1</code></td>
<td style="text-align: left;">speed factor (must be &gt; 1)</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>offset</code></td>
<td style="text-align: left;"><code>0</code></td>
<td style="text-align: left;">progress at start</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>running</code></td>
<td style="text-align: left;"><code>true</code></td>
<td style="text-align: left;">running or paused</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>clock</code></td>
<td style="text-align: left;"><code>start</code></td>
<td style="text-align: left;">current clock when running, set by <code>update()</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>resume_clock</code></td>
<td style="text-align: left;"><code>clock</code></td>
<td style="text-align: left;">current clock when paused, set by <code>update()</code></td>
</tr>
</tbody>
</table>
<p><strong>NOTE</strong>: Timing model fields can be changed anytime (there’s no internal state that must be kept in sync).</p>
<table>
<thead>
<tr class="header">
<th style="text-align: left;"><strong>method</strong></th>
<th style="text-align: left;"><strong>description</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><code>total_duration() -&gt; dt</code></td>
<td style="text-align: left;">total duration incl. repeats (can be <code>+/-inf</code>)</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>end_clock() -&gt; t</code></td>
<td style="text-align: left;">end clock (can be <code>+/-inf</code>)</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>is_infinite() -&gt; bool</code></td>
<td style="text-align: left;">true if <code>loop</code> and/or <code>duration</code> are <code>inf</code></td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>is_backwards(i) -&gt; bool</code></td>
<td style="text-align: left;">true if iteration <code>i</code> goes backwards</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>progress([t]) -&gt; P</code></td>
<td style="text-align: left;">linear progress in <code>0..1</code> incl. repeats (can be <code>inf</code>)</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>clock_at(P) -&gt; t</code></td>
<td style="text-align: left;">clock at total linear progress (which is in <code>0..1</code>)</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>status([t]) -&gt; status</code></td>
<td style="text-align: left;">status: ‘before_start’, ‘running’, ‘paused’, ‘finished’</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>loop_progress([t]) -&gt; p</code></td>
<td style="text-align: left;">linear progress in <code>0..loop</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>loop_clock_at(p) -&gt; t</code></td>
<td style="text-align: left;">clock at loop progress</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>distance([t]) -&gt; d</code></td>
<td style="text-align: left;">eased progress in current iteration (in <code>0..1</code>)</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>update([t])</code></td>
<td style="text-align: left;">update internal clock and target value</td>
</tr>
</tbody>
</table>
<p><strong>NOTE</strong>: <code>progress()</code>, <code>clock_at()</code> and <code>seek()</code> map time to <code>0..1</code> while <code>loop_progress()</code>, <code>loop_clock_at()</code> and <code>loop_seek()</code> map time to <code>0..loop</code>. The first set is more convenient but doesn’t work when <code>loop</code> is <code>inf</code>.</p>
<h4 id="changing-the-state-of-the-tween">Changing the state of the tween</h4>
<table>
<thead>
<tr class="header">
<th style="text-align: left;"><strong>method</strong></th>
<th style="text-align: left;"><strong>description</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><code>pause()</code></td>
<td style="text-align: left;">pause (changes <code>running</code>, prevents updating <code>clock</code>)</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>resume()</code></td>
<td style="text-align: left;">resume (changes <code>running</code> and <code>start</code>)</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>seek(P)</code></td>
<td style="text-align: left;">update target value based on progress (changes <code>start</code>).</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>loop_seek(p)</code></td>
<td style="text-align: left;">update target value based on loop progress (changes <code>start</code>).</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>stop()</code></td>
<td style="text-align: left;">pause and remove from timeline</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>restart()</code></td>
<td style="text-align: left;">restart (changes <code>start</code>)</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>reverse()</code></td>
<td style="text-align: left;">reverse (changes <code>start</code>, <code>offset</code>, <code>backwards</code>)</td>
</tr>
</tbody>
</table>
<p><strong>NOTE:</strong> The methods above change the timing model of the tween, which is normally supposed to be immutable in order to make the tween stateless. This is done to allow a tween that is part of a timeline to be paused and resumed independently of other tweens and of the timeline. Use <code>clone()</code> to preseve the initial definition of the tween.</p>
<h3 id="animation-model">Animation model</h3>
<table>
<thead>
<tr class="header">
<th style="text-align: left;"><strong>field</strong></th>
<th style="text-align: left;"><strong>default</strong></th>
<th style="text-align: left;"><strong>description</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><code>target</code></td>
<td style="text-align: left;">(required)</td>
<td style="text-align: left;">target object</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>attr</code></td>
<td style="text-align: left;">(required)</td>
<td style="text-align: left;">attribute in the target object to tween</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>from</code></td>
<td style="text-align: left;"><code>target[attr]</code></td>
<td style="text-align: left;">start value (defaults to target’s value)</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>to</code></td>
<td style="text-align: left;"><code>target[attr]</code></td>
<td style="text-align: left;">end value (defaults to target’s value)</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>type</code></td>
<td style="text-align: left;">per <code>attr</code></td>
<td style="text-align: left;">force attribute type</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>interpolate</code></td>
<td style="text-align: left;">default for <code>type</code></td>
<td style="text-align: left;"><code>f(t, x1, x2[, xout]) -&gt; x</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>get_value() -&gt; v</code></td>
<td style="text-align: left;"><code>target[attr] -&gt; v</code></td>
<td style="text-align: left;">value getter</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>set_value(v)</code></td>
<td style="text-align: left;"><code>target[attr] = v</code></td>
<td style="text-align: left;">value setter</td>
</tr>
</tbody>
</table>
<p>See below for how to add attribute type matching rules and interpolators.</p>
<p><strong>NOTE:</strong> Animation model fields are read/only. Changing them requires a call to <code>reset()</code>.</p>
<h3 id="relative-values">Relative values</h3>
<p><code>from</code> and <code>to</code> can be given in the format <code>'&lt;number&gt;'</code>, <code>'&lt;number&gt;&lt;unit&gt;</code>, <code>'&lt;operator&gt;=&lt;number&gt;'</code> or <code>'&lt;operator&gt;=&lt;number&gt;&lt;unit&gt;'</code>, where <code>operator</code> can be <code>+</code>, <code>-</code> or <code>*</code> and <code>unit</code> can be:</p>
<table>
<thead>
<tr class="header">
<th style="text-align: left;"><strong>unit</strong></th>
<th style="text-align: left;"><strong>description</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><code>%</code></td>
<td style="text-align: left;">percent, converted to <code>0..1</code></td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>ms</code></td>
<td style="text-align: left;">milliseconds, converted to seconds</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>deg</code></td>
<td style="text-align: left;">degrees, converted to radians</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>cw</code></td>
<td style="text-align: left;">rotation: clockwise</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>ccw</code></td>
<td style="text-align: left;">rotation: counter-clockwise</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>short</code></td>
<td style="text-align: left;">rotation: shortest direction</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>deg_cw</code></td>
<td style="text-align: left;">rotation: clockwise in degrees, converted to radians</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>deg_ccw</code></td>
<td style="text-align: left;">rotation: counter-clockwise in degrees, converted to radians</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>deg_short</code></td>
<td style="text-align: left;">rotation: shortest direction in degrees, converted to radians</td>
</tr>
</tbody>
</table>
<p>Examples: <code>'+=10deg'</code>, <code>'25%'</code>.</p>
<p><strong>NOTE:</strong> <code>'25%'</code> means 25% the initial value, while <code>'+=25%'</code> means 125% the initial value.</p>
<p><strong>NOTE:</strong> <code>cw</code> and <code>ccw</code> assume that increasing angles rotate the target clockwise (like cairo and other systems where the y-coord grows from top to bottom).</p>
<p><strong>NOTE:</strong> <code>'+=90deg'</code> means “rotate the target another 90 degrees clockwise”, while <code>'90deg_cw'</code> means “rotate the target to the 90 degrees mark by moving clockwise”. Don’t combine relative rotations with <code>cw</code> and <code>ccw</code>.</p>
<h3 id="misc.">Misc.</h3>
<table>
<thead>
<tr class="header">
<th style="text-align: left;"><strong>method</strong></th>
<th style="text-align: left;"><strong>description</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><code>tween:clone() -&gt; tween</code></td>
<td style="text-align: left;">clone a tween</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>tween:totarget() -&gt; obj</code></td>
<td style="text-align: left;">convert to tweenable object</td>
</tr>
</tbody>
</table>
<h3 id="tweenclone---tween"><code>tween:clone() -&gt; tween</code></h3>
<p>Clone a tween in its current state.</p>
<h3 id="tweentotarget---obj"><code>tween:totarget() -&gt; obj</code></h3>
<p>Create a proxy object for the tween with the additional tweenable fields <code>progress</code> and <code>loop_progress</code>. Other tweenable properties like <code>speed</code> remain accessible.</p>
<h2 id="timelines">Timelines</h2>
<h3 id="twtimelinet---tl"><code>tw:timeline(t) -&gt; tl</code></h3>
<p>Create a new timeline. A timeline is a list of tweens which are updated in parallel (or one after another, depending on their <code>start</code> time). The list can also contain other timelines, resulting in a hierarchy of timelines.</p>
<p><strong>NOTE:</strong> <code>t</code> itself is turned into a timeline (no new table is created).</p>
<h3 id="timelines-are-tweens">Timelines are tweens</h3>
<p>A timeline is itself a tween, containing all the fields and methods of the timing model of a tween (but none of the fields and methods of the animation model since it’s not animating a target object, it’s updating other tweens). This means that a timeline can be used to <em>tween</em> the <em>progress</em> of its child tweens instead of just updating them on the same clock, since it has a <code>distance</code> resulting from its timing model. It also means that the timeline can be itself tweened on its <em>progress</em> (which only works if the timeline is <em>not</em> infinite).</p>
<h3 id="tweening-other-tweens">Tweening other tweens</h3>
<p>Setting <code>tween_progress = true</code> on a timeline switches the timeline into tweening its child tweens on their <em>progress</em> (so tweening a temporal value) instead of just updating them on the same clock. In this mode, the child’s <code>start</code> and <code>duration</code> are ignored: instead, the timeline’s <code>distance</code> is interpolated over the child’s progress.</p>
<h3 id="timeline-specific-fields-and-methods">Timeline-specific fields and methods</h3>
<table>
<thead>
<tr class="header">
<th style="text-align: left;"><strong>field</strong></th>
<th><strong>default</strong></th>
<th style="text-align: left;"><strong>description</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><code>tweens</code></td>
<td><code>{}</code></td>
<td style="text-align: left;">the list of tweens in the timeline</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>ease</code></td>
<td><code>'linear'</code></td>
<td style="text-align: left;">(a better default for the <code>tween_progress</code> mode)</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>duration</code></td>
<td><code>0</code></td>
<td style="text-align: left;">auto-adjusted when adding tweens</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>auto_duration</code></td>
<td><code>true</code></td>
<td style="text-align: left;">auto-increase duration to include all tweens</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>auto_remove</code></td>
<td><code>true</code></td>
<td style="text-align: left;">remove tweens automatically when finished</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>tween_progress</code></td>
<td><code>false</code></td>
<td style="text-align: left;">progress-tweening mode</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr class="header">
<th style="text-align: left;"><strong>method</strong></th>
<th style="text-align: left;"><strong>description</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><code>add(tween|opt[, start])</code></td>
<td style="text-align: left;">add a tween or create multiple tweens</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>each(func, ...)</code></td>
<td style="text-align: left;">iterate tweens recursively</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>remove(tween|attr|target)</code></td>
<td style="text-align: left;">remove matching tweens recursively</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>clear()</code></td>
<td style="text-align: left;">remove all tweens (non-recursively)</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>status([t])</code></td>
<td style="text-align: left;">adds <code>'empty'</code> status</td>
</tr>
</tbody>
</table>
<h3 id="tladdtweenopt-start---tl"><code>tl:add(tween|opt[, start]) -&gt; tl</code></h3>
<p>Add a new tween to the timeline, set its <code>start</code> field and its <code>timeline</code> field, and, if <code>auto_duration</code> is <code>true</code>, increase timeline’s <code>duration</code> to include the entire tween. When part of a timeline, a tween’s <code>start</code> is relative to the timeline’s start time. If <code>start</code> is not given, the tween is added to the end of the timeline (when the timeline’s duration is infinite then the tween’s start is set to <code>0</code> instead).</p>
<p>If an options table is given instead, multiple tweens are created and added to the timeline as follows: <code>targets</code> specifies a list of targets, otherwise <code>target</code> specifies a single target, <code>from</code> and <code>to</code> specifies a table of from/to attribute -&gt; value pairs. <code>cycle_from</code>, <code>cycle_to</code>, <code>cycle</code> specifies a table of from/to attribute -&gt; list-of-values pairs such that values will be distributed to each target in a round-robin fashion. The values can also be functions. More on cylcling <a href="https://greensock.com/cycle/">here</a>.</p>
<p><strong>NOTE:</strong> <code>start</code> can be a relative value relative to the timeline’s current total duration, eg. <code>'+=500ms'</code> means half a second after the last tween, while <code>'500ms'</code> means half a second from the start of the timeline.</p>
<h3 id="tleachfunc-..."><code>tl:each(func, ...)</code></h3>
<p>Run <code>func(tween)</code> for each tween of a timeline, recursively. Returning <code>false</code> from <code>func</code> breaks the iteration. Returning <code>'remove'</code> removes the tween. Returning another tween replaces the tween.</p>
<h3 id="tlremovetweenattrtargetidfunc"><code>tl:remove(tween|attr|target|id|func)</code></h3>
<p>Remove a tween or all tweens with a specific attribute, target object or id recursively.</p>
<h3 id="tlclear"><code>tl:clear()</code></h3>
<p>Remove all tweens from the timeline (non-recursively).</p>
<h2 id="the-tweening-module">The tweening module</h2>
<h3 id="tw---tw"><code>tw() -&gt; tw</code></h3>
<p>Create a new <code>tweening</code> module. Useful for extending the <code>tweening</code> module with new attribute types, new interpolators or different ways of getting the wall clock without affecting the original module table.</p>
<h3 id="attribute-types-and-interpolators">Attribute types and interpolators</h3>
<h3 id="tw.type.namepatternmatch_func-attr_type"><code>tw.type.&lt;name|pattern|match_func&gt; = attr_type</code></h3>
<p>Tell tweening about the type of an attribute, eg. <code>tw.type['_color$'] = 'list'</code></p>
<h3 id="tw.interpolate.attr_type-functiond-x1-x2-xout---x"><code>tw.interpolate.&lt;attr_type&gt; = function(d, x1, x2[, xout]) -&gt; x</code></h3>
<p>Add a new interpolation function for an attribute type. Interpolators are called as <code>x = f(d, x1, x2, x)</code> and can update <code>x</code> in-place and return it thus avoiding an allocation on every frame if <code>x</code> is a non-scalar type.</p>
<h3 id="value-parsers">Value parsers</h3>
<h3 id="twparse_valuev-relative_to-tween---v"><code>tw:parse_value(v, relative_to, tween) -&gt; v</code></h3>
<p>Parse a value.</p>
<h3 id="the-wall-clock">The wall clock</h3>
<h3 id="twclocktfalse---t"><code>tw:clock([t|false]) -&gt; t</code></h3>
<p>Get/freeze/unfreeze the wall clock. With <code>t</code> it freezes the wall clock such that subsequent <code>tw:clock()</code> calls will return <code>t</code>. With <code>false</code> it unfreezes it such that subsequent <code>tw:clock()</code> calls will return <code>tw:current_clock()</code>.</p>
<p>Freezing is useful for creating multiple tweens which start at the exact same time without having to specify the time.</p>
<h3 id="twcurrent_clock---t"><code>tw:current_clock() -&gt; t</code></h3>
<p>Current monotonic performance counter, in seconds. Implemented in terms of <a href="/time">time.clock()</a>. Override this in order to remove the dependency on the <a href="/time">time</a> module.</p>
<h3 id="easing">Easing</h3>
<h3 id="tweaseease-way-p-i---d"><code>tw:ease(ease, way, p, i) -&gt; d</code></h3>
<p>Implemented in terms of <a href="/easing">easing.ease()</a>. Override this in order to remove the dependency on the <a href="/easing">easing</a> module.</p>
