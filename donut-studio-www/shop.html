<!DOCTYPE html>
<html>
<head>
<title>Donut Studio</title>
<meta name="viewport" content="width=300, initial-scale=1, maximum-scale=1, user-scalable=no">
<style>
* {
	box-sizing: border-box;
	user-select: text;
	touch-action: manipulation;
}

html, body {
	margin: 0;
	padding: 0;
	width: 100%;
	height: 100%;
	position: relative;
	overflow: hidden;
	font-family: sans-serif;
}
#page_list {
	width: 100%;
	height: 100%;
	position: relative;
	overflow: visible;
	left: 0;
	transition: left .2s;
	display: flex;
}
#browse_page {
	width: 100%;
	display: flex;
	flex-flow: column;
	position: relative;
}
#order_page {
	background: white;
	z-index: 1;
}
#order_page, #thanks_page {
	display: none;
	flex-flow: column;
	position: relative;
	overflow: auto;
}
#logo {
	margin: 20px 0 40px 0;
	min-width: 0;
	min-height: 0;
	max-height: 20%;
	z-index: 1;
	align-self: center;
	filter: drop-shadow(2px 2px 2px #222);
	pointer-events: none;
}
#product_viewport {
	margin-top: -20%;
	flex: 1;
	position: relative;
	display: flex;
	touch-action: none;
	overflow: hidden;
	box-shadow: 0px 2px 6px #222;
}
#product_list {
	position: relative;
	display: flex;
	align-items: center;
}
#product_list:not(.swiping) {
	transition: left .1s;
}
.product-img {
	display: none;
	object-fit: contain;
	filter: drop-shadow(5px 5px 5px #222);

	transform: translatey(0px);
	animation: float 6s ease-in-out infinite;
}
.product-img:nth-child(3n+0) { animation-delay: -1s; }
.product-img:nth-child(3n+1) { animation-delay: -4s; }
.product-img:nth-child(3n+2) { animation-delay: -2s; }
.product-img.move_to_cart {
	position: absolute;
	pointer-events: none;
	filter: none;
}
.product-img.move_to_cart_moving {
	z-index: 3;
	transition: top .4s, left .4s, width .4s, height .4s;
}
@keyframes float {
	0% {
		filter: drop-shadow(5px 5px 2px rgba(0,0,0,0.3));
		transform: translatey(0px);
	}
	50% {
		filter: drop-shadow(5px 5px 15px rgba(0,0,0,0.6));
		transform: translatey(-15px);
	}
	100% {
		filter: drop-shadow(5px 5px 2px rgba(0,0,0,0.3));
		transform: translatey(0px);
	}
}
#cart_viewport {
	padding: 0 5px;
	z-index: 2;
	overflow: auto;
	overflow-x: auto;
	overflow-y: hidden;
	display: flex;
	border-top: 1px solid #ccc;
	height: 0;
	transition: height .2s;
}
#cart_list {
	position: relative;
	display: flex;
	align-items: center;
}
.cart-item {
	position: relative;
	top: 0px;
	opacity: 1;
	transition: top .2s, opacity .2s;
	display: flex;
	flex-flow: column;
	align-items: flex-end;
}
.cart-img {
	height: 50px;
	min-width: 60px;
	object-fit: contain;
	filter: drop-shadow(2px 2px 2px #222);
	transition: width .2s;
}
.cart-qty {
	font-weight: bold;
	font-size: 12px;
	padding-right: 6px;
	padding-top: 4px;
}
.cart-qty::after {
	content: ' buc'
}
#order_bar {
	height: 60px;
	display: flex;
	justify-content: space-between;
	align-items: center;
	background: rgb(237, 27, 36);
	color: white;
	box-shadow: 0px 2px 4px #222;
	z-index: 1;
}
#order_btn {
	border: none;
	background: none;
	color: white;
	font-size: 30px;
	padding: .4em;
	position: relative;
	overflow: hidden;
	user-select: none;
}
.totals {
	padding: 20px 20px;
	display: grid;
	grid: auto auto / auto auto auto;
	flex: 1;
}
.ron {
	font-size: 14px;
	padding-left: .4em;
	align-self: top;
	padding-top: 3px;
}
.percent {
	font-size: 14px;
	padding-left: .4em;
	align-self: center;
}
.total {
	font-size: 24px;
}
.discount {
	font-size: 14px;
}
#total {
	text-align: right;
}
#discount {
	justify-self: right;
}
#footer {
	padding: 10px 20px;
	background: rgb(51, 51, 51);
	color: white;
	font-size: 14px;
	line-height: 1.5em;
	min-height: 40px;
	display: flex;
	justify-content: space-between;
}
#footer_left {
	flex: 1;
}
#footer_right {
	text-align: right;
	align-self: center;
	display: flex;
	align-items: center;
	justify-content: flex-end;
}
#footer a {
	display: block;
	color: white;
	text-decoration: none;
	white-space: nowrap;
}
.section-label {
	font-size: 18px;
	color: #777;
	margin: .5em 0 -.25em 1em;
}

/* input with inner label ------------------------------------------------- */

#phone { margin-top: 1em; }

.x-input, select, #place_order_btn, #back_btn {
	margin: .5em 1em;
	border: 1px solid #999;
	border-radius: .3em;
	line-height: 1.5em;
	font-size: 18px;
	font-family: inherit;
}
#place_order_btn {
	background: rgb(255, 206, 111);
	display: flex;
	align-items: center;
	justify-content: center;
}
#back_btn {
	background: #ccc;
	display: flex;
	align-items: center;
	justify-content: center;
}
.x-input-value {
	font-family: inherit;
	font-size: inherit;
}
.x-input-value, .x-input-inner-label, select, #place_order_btn, #back_btn {
	padding: 1em .5em;
	max-width: 100%;
}
.x-input-value, select {
	background: none;
	color: inherit;
	text-align: left;
	min-width: 0;
}
.x-input {
	display: flex;
	position: relative; /* anchor the inner label to it */
}
.x-input-value, .x-input-inner-label {
	margin: 0;
	border: 0;
	width: 100%;             /* stretch horizontally */
	height: 100%;            /* stretch vertically */
}
.x-input-value:focus {
	outline: none;
}
.x-input-inner-label {
	align-self: flex-start;
	position: absolute;
	pointer-events: none;       /* click-through */
	color: #777;
	white-space: nowrap;
	overflow: hidden;
	text-overflow: ellipsis;
}
.x-input > .x-input-value:not(.empty) {
	top: 0; /* fixate to top so we only have to set the top padding */
	padding: 1.5em .5em .5em .5em;
}
.x-input > .x-input-inner-label:not(.empty) {
	top: 0; /* fixate to top so we only have to set the top padding */
	user-select: none;
	font-size: 85%;
	padding-top: .2em;
	animation: x-input-inner-label-focused .2s;
}
@keyframes x-input-inner-label-focused {
	from {
		opacity: 0;
		padding-top: .6em;
	}
}

/* payment method choser -------------------------------------------------- */

#pay_methods {
	margin: .5em 1em;
	display: flex;
	justify-content: stretch;
}
.pay-method {
	flex: 1;
	padding: .5em;
	border: 1px solid #999;
	display: flex;
	align-items: center;
}
.pay-method:nth-child(1) {
	border-top-left-radius: .3em;
	border-bottom-left-radius: .3em;
	border-right: none;
}
.pay-method:nth-child(3) {
	border-top-right-radius: .3em;
	border-bottom-right-radius: .3em;
	border-left: none;
}
.pay-method.selected {
	background: #47a;
	color: white;
}

.total2 {
	color: red;
	//font-weight: bold;
}

/* thanks page ------------------------------------------------------------ */

#thanks_page {
	display: none;
	flex-flow: column;
	justify-content: center;
	align-items: center;

	background-color: black;
	background: url("smile.jpg");
	background-position: calc(50% - 160px) calc(50% - 70px);
}

#order_placed_message {
	padding: .2em 1em;
	color: white;
	background: black;
	font-size: 24px;
}
#order_placed_subtext {
	padding: .3em .4em;
	color: white;
	background: black;
	font-size: 14px;
}

/* landscape mode --------------------------------------------------------- */

@media (orientation: landscape) {
	#logo {
		display: none;
	}
	#product_viewport {
		margin-top: 0;
	}
}

</style>
<script src="glue.js"></script>
<script src="divs.js"></script>
<script src="ajax.js"></script>

</head>

<body id=body>

<div id=page_list>

	<div id=browse_page>
		<img id=logo src=logo.png>
		<div id=product_viewport>
			<div id=product_list>
				<img class=product-img src=1.png>
				<img class=product-img src=2.png>
				<img class=product-img src=3.png>
			</div>
		</div>
		<div id=cart_viewport>
			<div id=cart_list>
			</div>
		</div>
		<div id=order_bar>
			<div class=totals>
				<div class=total>Total</div>
					<div class=total id=total>0</div>
					<div class=ron>RON</div>
				<div class=discount>Discount</div>
					<div class=discount id=discount>0</div>
					<div class=percent>RON</div>
			</div>
			<button id=order_btn>Comand&#259;</button>
		</div>
		<div id=footer>
			<div id=footer_left>
				<a href="/events">Events / Corporate</a>
				<a href="/contact">Contact</a>
			</div>
			<div id=footer_right>
				<img src=facebook.png style="width: 50%">
			</div>
		</div>
	</div>

	<div id=order_page>
		<div id=order_products>
		</div>
		<div class="x-input" id=phone>
			<input class="x-input-value empty" type=tel>
			<div class="x-input-inner-label empty">Telefon</div>
		</div>
		<div class="x-input" id=address>
			<input class="x-input-value empty">
			<div class="x-input-inner-label empty">Strada, Bloc, Scara, Etaj, Ap., Interfon</div>
		</div>
		<div class=section-label>Metoda de plata</div>
		<div id=pay_methods>
			<div class="pay-method selected" name="cash">Cash</div>
			<div class=pay-method name="POS">Card la<br>livrare</div>
			<div class=pay-method name="bank">In cont</div>
		</div>
		<div class=section-label>Data &#537;i ora livr&#259rii</div>
		<div style="display: flex">
			<select id=delivery_date style="flex: 2; margin-right: 0"></select>
			<select id=delivery_time style="flex: 1; margin-left: .5em">
				<option>8-10</option>
				<option selected>10-14</option>
				<option>14-18</option>
				<option>18-20</option>
			</select>
		</div>
		<div class=section-label>Total de plat&#259:
			<span id=total2 class=total2></span>
			<span class=total2>RON</span>
		</div>
		<button id=place_order_btn>Plaseaza Comanda</button>
	</div>

	<div id=thanks_page>
		<div id=order_placed_message>
			Comanda a fost plasat&#259;
			<div id=order_placed_subtext>
				&#206;n scurt timp vei primi un mesaj scris de confirmare.
			</div>
		</div>
		<button id=back_btn>Inapoi la site</button>
	</div>

</div>

<script>

// page slider ---------------------------------------------------------------

selected_page_index = 0

pages = [
	{title: 'Donut Studio', url: '/'},
	{title: 'Comanda - Donut Studo', url: '/comanda'},
	{title: 'Multumim - Donut Studo', url: '/multumim'},
]

function select_page_on_url_bar() {
	for (let i = 0; i < pages.length; i++)
		if (pages[i].url == location.pathname) {
			select_page(i, true)
			break
		}
}

window.onpopstate = select_page_on_url_bar

function select_page(i, nopush) {
	selected_page_index = i
	let w = body.client_rect().w
	page_list.x = -i * w
	if (!nopush)
		window.history.pushState('', pages[i].title, pages[i].url)
}

document.on('layout_changed', function() {
	let w = body.client_rect().w
	browse_page.min_w = w
	order_page.min_w = w
	thanks_page.min_w = w
	order_page.style.display = 'flex'
	thanks_page.style.display = 'flex'
	select_page(selected_page_index)
})

// products ------------------------------------------------------------------

products = [
	{
		title: 'Box o\'donuts',
		id: 1,
		price: 50,
		qty: 12,
	},
	{
		title: 'Sweet donut',
		id: 2,
		price: 5,
		qty: 1,
	},
	{
		title: 'Even sweeter',
		id: 3,
		price: 6,
		qty: 1,
	},
]

function product_index_by_id(id) {
	for (let i = 0; i < products.length; i++)
		if (products[i].id == id)
			return i
}

// product image fit container height ----------------------------------------

view_w = null
view_h = null

function get_product_viewport_size() {
	view_w = product_viewport.clientWidth
	view_h = product_viewport.clientHeight
}

function resize_product_image(p) {
	let w0 = p.naturalWidth
	let h0 = p.naturalHeight
	p.h = min(view_w, view_h)
	p.w = min(view_w, view_h)
	p.style.display = 'flex'
	select_product(selected_product_index)
}
function product_image_loaded(ev) {
	resize_product_image(this)
}
for (let p of product_list.children)
	p.onload = product_image_loaded

document.on('layout_changed', function() {
	for (let p of product_list.children)
		p.hide()
	get_product_viewport_size()
	for (let p of product_list.children)
		resize_product_image(p)
})

// product selection ---------------------------------------------------------

selected_product_index = 0

function select_product(index) {
	index = clamp(index, 0, product_list.at.length - 1)
	selected_product_index = index
	let x = 0
	for (let i = 0; i < index; i++) {
		let p = product_list.at[i]
		x += p.offsetWidth
	}
	product_list.x = -x
		- product_list.at[index].offsetWidth / 2
		+ product_viewport.clientWidth / 2
}

document.on('keydown', function(key) {
	if (key == 'ArrowLeft' || key == 'ArrowRight') {
		select_product(selected_product_index += (key == 'ArrowLeft' ? -1 : 1))
		return false
	}
})

product_viewport.on('pointerdown', function(ev, mx, my) {

	let x0 = product_list.offsetLeft
	let dx = mx - this.client_rect().x - x0

	function pointermove(mx, my) {
		mx -= this.client_rect().x
		product_list.x = mx - dx
		return false
	}

	function pointerup() {
		product_list.class('swiping', false)
		let dx = x0 - product_list.offsetLeft
		if (abs(dx) <= 10) {
			select_product(selected_product_index)
			add_to_cart(selected_product_index, 1)
		} else {
			let i = selected_product_index + (dx < 0 ? -1 : 1)
			select_product(i)
		}
		return false
	}

	product_list.class('swiping', true)

	return this.capture_pointer(ev, pointermove, pointerup)
})

// cart operations -----------------------------------------------------------

function update_cart() {
	let t = 0
	let q = 0
	let cart = {}
	for (let cart_item of cart_list.children) {
		let prod = products[cart_item.product_index]
		let qc = cart_item.qty
		t += prod.price * qc
		q += qc * prod.qty
		cart[prod.id] = qc
	}
	let d = (q >= 72 ? 15 : (q >= 48 ? 10 : (q >= 24 ? 5 : 0))) / 100
	t = round(t)
	d = round(-t * d)
	total.set(t)
	discount.set(d)
	total2.set(t + d)
	localStorage.setItem('cart', json(cart))
}

function update_cart_height(open) {
	cart_viewport.h = open ? 80 : 0
}

function update_cart_item(cart_item) {
	cart_item.at[1].html = cart_item.qty
	update_cart()
}

function add_to_cart(product_index, qty, animated) {

	let prod_img = product_list.at[product_index]
	let aspect_ratio = prod_img.naturalWidth / prod_img.naturalHeight

	let cart_item

	for (let cart_item1 of cart_list.children)
		if (cart_item1.product_index == product_index) {
			cart_item = cart_item1
			break
		}

	if (!cart_item) {
		let cart_img = H.img({
			class: 'cart-img',
			src: prod_img.attr('src'),
		})
		cart_img.w = 50 * aspect_ratio
		let cart_qty = div({class: 'cart-qty'})
		cart_item = div({class: 'cart-item'}, cart_img, cart_qty)
		if (animated != false)
			cart_item.style.visibility = 'hidden'
		cart_item.product_index = prod_img.index
		cart_item.qty = 0
		cart_item.on('pointerdown', cart_item_pointerdown)
		cart_list.add(cart_item)
	}

	update_cart_height(true)

	if (animated == false) {
		cart_item.qty += qty
		update_cart_item(cart_item)
		return
	}

	let or = order_bar.client_rect()
	let cr = cart_item.at[0].client_rect()
	let pr = prod_img.client_rect()
	let mr = body.client_rect()

	let move_img = prod_img.cloneNode()
	move_img.classes = 'move_to_cart'
	move_img.style.left = (pr.x - mr.x)+'px'
	move_img.style.top  = (pr.y - mr.y)+'px'
	body.add(move_img)

	after(.4, function() {
		move_img.remove()
		cart_item.qty += qty
		update_cart_item(cart_item)
		cart_item.style.visibility = null
	})

	after(0.01, function() {
		move_img.classes = 'move_to_cart_moving'
		move_img.style.left   = (cr.x - mr.x)+'px'
		move_img.style.top    = (or.y - 80 - mr.y)+'px'
		move_img.style.width  = (cr.w)+'px'
		move_img.style.height = (cr.h)+'px'
	})

}

{
	let allow_remove = true
	let cart_item0, mx0, my0
	function cart_item_pointerdown(ev, mx, my) {
		if (!allow_remove)
			return
		mx0 = mx
		my0 = my
		cart_item0 = this
	}

	cart_viewport.on('pointerup', function(mx, my, ev) {
		if (!cart_item0)
			return
		if (abs(mx - mx0) > 4 || abs(my - my0) > 4)
			return

		allow_remove = false
		cart_item = cart_item0

		if (cart_item.qty <= 1) {

			cart_item.style.top = '-20px'
			cart_item.style.opacity = 0
			cart_item.at[0].w = 0

			after(.2, function() {
				cart_item.remove()
				update_cart()
				update_cart_height(cart_list.at.length > 0)
				allow_remove = true
			})

		} else {
			cart_item.qty--
			update_cart_item(cart_item)
			allow_remove = true
		}

		return false
	})
}

function empty_cart() {
	cart_list.clear()
	update_cart()
	update_cart_height(false)
}

// ordering ------------------------------------------------------------------

order_btn.oncontextmenu = (() => false)

order_btn.on('click', function() {
	select_page(1)
})

// input inner label state ---------------------------------------------------

document.on('input', function(ev) {

	// input inner label state change.
	let e = ev.target.parent
	let input = e.at[0]
	let inner_label = e.at[1]
	let s = input.value
	input.class('empty', s == '')
	inner_label.class('empty', s == '')

	// save value to local storage.
	localStorage.setItem(e.attr('id'), input.value)
})

// select payment method -----------------------------------------------------

pay_method_index = 0

function select_pay_method(i) {
	pay_methods.at[pay_method_index].class('selected', false)
	pay_method_index = i
	pay_methods.at[i].class('selected')
	localStorage.setItem('pay_method', i)
}

document.on('click', function(ev) {
	if (!ev.target.hasclass('pay-method'))
		return
	select_pay_method(ev.target.index)
})

// place order ---------------------------------------------------------------

place_order_btn.on('click', function() {
	ajax({
		url: '/plaseaza-comanda',
		upload: localStorage.getItem('cart'),
		success: function(res) {
			empty_cart()
			select_page(2)
			update_thanks_page(res)
		},
		fail: function(err, status, message, body) {
			print(err, status, message, body)
		}
	}).send()

})

// thanks page ---------------------------------------------------------------

function update_thanks_page(res) {
	print(res.order_id)
}

back_btn.on('click', function() {
	select_page(0)
})

// init ----------------------------------------------------------------------


window.onload = function() {

	for (let id of ['phone', 'address']) {
		let input = window[id].at[0]
		input.value = localStorage.getItem(id)
		input.fire('input')
	}
	select_pay_method(localStorage.getItem('pay_method') || 0)

	let t = time()
	let opt = {weekday: 'long', month: 'long', day: 'numeric'}
	for (let i = 1; i <= 60; i++) {
		let d = day(t, i)
		let s = _d.toLocaleDateString('ro', opt)
		if (i == 1)
			s = 'maine, '+s
		delivery_date.add(tag('option', {value: d}, s))
	}

	select_page_on_url_bar()

	let cart = JSON.parse(localStorage.getItem('cart')) || {}
	for (let pid in cart) {
		let i = product_index_by_id(pid)
		if (i != null)
			add_to_cart(i, cart[pid], selected_page_index == 0)
	}

	document.fire('layout_changed')

}

</script>
</body>
</html>
