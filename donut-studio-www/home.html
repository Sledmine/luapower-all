<!DOCTYPE html>
<html>
<head>
<title>Donut Studio</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
.shadow {
	filter: drop-shadow(5px 5px 5px #222);
}
html, body {
	width: 100%;
	height: 100%;
	margin: 0;
	padding: 0;
	font-family: sans-serif;
	overflow: hidden;
}
#main {
	display: flex;
	flex-flow: column;
	position: relative;
}
#logo {
	margin: 20px 0 40px 0;
	min-width: 0;
	min-height: 0;
	max-height: 30%;
	z-index: 1;
	align-self: center;
	filter: drop-shadow(2px 2px 2px #222);
	pointer-events: none;
}
#product_viewport {
	margin-top: -100px;
	flex: 1;
	position: relative;
	display: flex;
	touch-action: none;
	overflow: hidden;
}
#product_list {
	position: relative;
	display: flex;
	align-items: center;
}
#product_list:not(.swiping) {
	transition: left .1s;
}
.product_image {
	display: none;
	object-fit: contain;
	filter: drop-shadow(5px 5px 5px #222);

	transform: translatey(0px);
	animation: float 6s ease-in-out infinite;
}
.product_image.move_to_cart {
	position: absolute;
	pointer-events: none;
	filter: none;
}
.product_image.move_to_cart_moving {
	z-index: 3;
	transition: top .4s, left .4s, width .4s, height .4s;
}
@keyframes float {
	0% {
		filter: drop-shadow(5px 5px 2px rgba(0,0,0,0.3));
		transform: translatey(0px);
	}
	50% {
		filter: drop-shadow(5px 5px 15px rgba(0,0,0,0.6));
		transform: translatey(-15px);
	}
	100% {
		filter: drop-shadow(5px 5px 2px rgba(0,0,0,0.3));
		transform: translatey(0px);
	}
}
.order_bar {
	background: rgb(255, 206, 111);
	color: white;
}
#cart_viewport {
	padding: 10px 5px;
	z-index: 2;
	overflow: auto;
	display: flex;
}
#cart_list {
	position: relative;
	display: flex;
	align-items: center;
	height: 50px;
}
#cart_list:not(.swiping) {
	transition: left 1s;
}
.product_image_cart {
	height: 50px;
	object-fit: contain;
	filter: drop-shadow(2px 2px 2px #222);
	position: relative;
	opacity: 1;
	top: 0px;
	transition: width .2s, top .2s, opacity .2s;
}
#order_bar {
	height: 60px;
	display: flex;
	justify-content: space-between;
	align-items: center;
	border-top: 1px solid #fff;
}
#order_btn {
	font-size: 30px;
	padding: .4em;
	position: relative;
	overflow: hidden;
}
#order_btn:after {
	content: "";
	background: #eee;
	display: block;
	position: absolute;
	padding-top: 300%;
	padding-left: 350%;
	margin-left: -20px!important;
	margin-top: -120%;
	opacity: 0;
	transition: all 0.8s
}
#order_btn:active:after {
	padding: 0;
	margin: 0;
	opacity: 1;
	transition: 0s
}
.totals {
	padding: 20px 20px;
	display: grid;
	grid: auto auto / auto auto auto;
	flex: 1;
}
.ron {
	font-size: 14px;
	padding-left: .4em;
	align-self: top;
	padding-top: 3px;
}
.percent {
	font-size: 14px;
	padding-left: .4em;
	align-self: center;
}
.total {
	font-size: 24px;
}
.discount {
	font-size: 14px;
}
#total {
	text-align: right;
}
#discount {
	justify-self: right;
}
#footer {
	padding: 10px 20px;
	background: rgb(51, 51, 51);
	color: white;
	font-size: 14px;
	line-height: 1.5em;
	min-height: 40px;
	display: flex;
	justify-content: space-between;
	box-shadow: inset 0px 2px 4px #222;
}
#footer_left {
	flex: 1;
}
#footer_right {
	text-align: right;
	align-self: center;
	display: flex;
	align-items: center;
	justify-content: flex-end;
}
</style>
<script src="glue.js"></script>
<script src="divs.js"></script>
</head>

<body id=main>
<img id=logo src=logo.png>
<div id=product_viewport>
	<div id=product_list>
		<img class=product_image src=1.png>
		<img class=product_image src=2.png>
		<img class=product_image src=3.png>
	</div>
</div>
<div id=cart_viewport class=order_bar>
	<div id=cart_list>
	</div>
</div>
<div id=order_bar class=order_bar>
	<div class=totals>
		<div class=total>Total</div>
			<div class=total id=total>0</div>
			<div class=ron>RON</div>
		<div class=discount>Discount</div>
			<div class=discount id=discount>0</div>
			<div class=percent>%</div>
	</div>
	<div id=order_btn>Comand&#259;</div>
</div>
<div id=footer>
	<div id=footer_left>
		<div>Events / Corporate</div>
		<div>Contact</div>
	</div>
	<div id=footer_right>
		<img src=facebook.png style="width: 50%">
	</div>
</div>
<script>

products = [
	{
		title: 'Box o\'donuts',
		id: 1,
		price: 50,
	},
	{
		title: 'Sweet donut',
		id: 2,
		price: 5,
	},
	{
		title: 'Even sweeter',
		id: 3,
		price: 6,
	},
]

// product image fit container height ----------------------------------------

view_w = null
view_h = null

function get_product_viewport_size() {
	view_w = product_viewport.clientWidth
	view_h = product_viewport.clientHeight
}

function resize_product_image(p) {
	let w0 = p.naturalWidth
	let h0 = p.naturalHeight
	p.h = min(view_w, view_h)
	p.w = min(view_w, view_h)
	p.style.display = 'flex'
	select_product(selected_product_index)
}
function product_image_loaded(ev) {
	resize_product_image(this)
}
for (let p of product_list.children)
	p.onload = product_image_loaded

document.on('layout_changed', function() {
	for (let p of product_list.children)
		p.hide()
	get_product_viewport_size()
	for (let p of product_list.children)
		resize_product_image(p)
})

// product selection ---------------------------------------------------------

selected_product_index = 0

function select_product(index) {
	index = clamp(index, 0, product_list.at.length - 1)
	selected_product_index = index
	let x = 0
	for (let i = 0; i < index; i++) {
		let p = product_list.at[i]
		x += p.offsetWidth
	}
	product_list.x = -x
		- product_list.at[index].offsetWidth / 2
		+ product_viewport.clientWidth / 2
}

document.on('keydown', function(key) {
	if (key == 'ArrowLeft' || key == 'ArrowRight') {
		select_product(selected_product_index += (key == 'ArrowLeft' ? -1 : 1))
		return false
	}
})

product_viewport.on('pointerdown', function(ev, mx, my) {

	let x0 = product_list.offsetLeft
	let dx = mx - this.client_rect().x - x0

	function pointermove(mx, my) {
		mx -= this.client_rect().x
		product_list.x = mx - dx
		return false
	}

	function pointerup() {
		product_list.class('swiping', false)
		let dx = x0 - product_list.offsetLeft
		if (abs(dx) <= 10) {
			select_product(selected_product_index)
			add_to_cart()
		} else {
			let i = selected_product_index + (dx < 0 ? -1 : 1)
			select_product(i)
		}
		return false
	}

	product_list.class('swiping', true)

	return this.capture_pointer(ev, pointermove, pointerup)
})

// cart operations -----------------------------------------------------------

function update_totals() {
	let x = 0
	let d = 0
	for (let cart_img of cart_list.children) {
		let p = products[cart_img.product_index]
		x += p.price
	}
	total.set(x)
}

function add_to_cart() {

	let prod_img = product_list.at[selected_product_index]
	let aspect_ratio = prod_img.naturalWidth / prod_img.naturalHeight

	let cart_img = H.img({
		class: 'product_image_cart',
		src: prod_img.attr('src'),
		style: 'visibility: hidden',
	})
	cart_img.product_index = prod_img.index
	cart_img.w = 50 * aspect_ratio
	cart_list.add(cart_img)

	let cr = cart_img.client_rect()
	let pr = prod_img.client_rect()
	let mr = main.client_rect()

	let move_img = prod_img.cloneNode()
	move_img.classes = 'move_to_cart'
	move_img.style.left = (pr.x - mr.x)+'px'
	move_img.style.top  = (pr.y - mr.y)+'px'
	main.add(move_img)

	after(.4, function() {
		move_img.remove()
		cart_img.style.visibility = null
	})

	after(0.01, function() {
		move_img.classes = 'move_to_cart_moving'
		move_img.style.left   = (cr.x - mr.x)+'px'
		move_img.style.top    = (cr.y - mr.y)+'px'
		move_img.style.width  = (cr.w)+'px'
		move_img.style.height = (cr.h)+'px'
	})

	update_totals()

}

{
	let allow_remove = true
	let cart_img, mx0, my0
	cart_viewport.on('pointerdown', function(ev, mx, my) {
		mx0 = mx
		my0 = my
		cart_img = allow_remove && ev.target.product_index != null && ev.target || null
	})

	cart_viewport.on('pointerup', function(mx, my, ev) {
		if (!cart_img)
			return
		if (abs(mx - mx0) > 4 || abs(my - my0) > 4)
			return
		allow_remove = false
		cart_img.style.top = '-20px'
		cart_img.w = 0
		cart_img.style.opacity = 0
		let cart_img1 = cart_img
		after(.2, function() {
			cart_img1.remove()
			update_totals()
			allow_remove = true
		})
		return false
	})
}

// init ----------------------------------------------------------------------

window.onload = function() {
	document.fire('layout_changed')
}

</script>
</body>
</html>
