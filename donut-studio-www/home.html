<!DOCTYPE html>
<html>
<head>
<title>Donut Studio</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
.shadow {
	filter: drop-shadow(5px 5px 5px #222);
}
html, body {
	width: 100%;
	height: 100%;
	margin: 0;
	padding: 0;
	font-family: sans-serif;
	overflow: hidden;
}
#main {
	display: flex;
	flex-flow: column;
	position: relative;
}
#logo {
	margin: 20px 0 40px 0;
	min-width: 0;
	min-height: 0;
	max-height: 30%;
	z-index: 1;
	align-self: center;
	filter: drop-shadow(2px 2px 2px #222);
	pointer-events: none;
}
#product_viewport {
	margin-top: -100px;
	flex: 1;
	position: relative;
	display: flex;
	touch-action: none;
	overflow: hidden;
}
#product_list {
	position: relative;
	display: flex;
	align-items: center;
}
#product_list:not(.swiping) {
	transition: left .1s;
}
.product_image {
	display: none;
	object-fit: contain;
	filter: drop-shadow(5px 5px 5px #222);
}
.product_image.move_to_cart {
	position: absolute;
	pointer-events: none;
	filter: none;
}
.product_image.move_to_cart_moving {
	z-index: 3;
	transition: top .4s, left .4s, width .4s, height .4s;
}
.order_bar {
	background: rgb(255, 206, 111);
	color: white;
}
#cart_viewport {
	padding: 10px 5px;
	z-index: 2;
	overflow: hidden;
	display: flex;
}
#cart_list {
	position: relative;
	display: flex;
	align-items: center;
	height: 50px;
}
#cart_list:not(.swiping) {
	transition: left 1s;
}
.product_image_cart {
	height: 50px;
	object-fit: contain;
	filter: drop-shadow(2px 2px 2px #222);
	position: relative;
	opacity: 1;
	top: 0px;
	transition: width .4s, top .4s, opacity .4s;
}
#order_bar {
	height: 60px;
	display: flex;
	justify-content: space-between;
	align-items: center;
	border-top: 1px solid #999;
}
#totals {
	padding: 20px 20px;
	display: grid;
	grid: auto / auto auto;
}
#order_btn {
	font-size: 30px;
	margin: 0 20px;
}
.total {
	font-size: 24px;
}
.discount {
	font-size: 14px;
}
#total {
	justify-self: right;
}
#discount {
	justify-self: right;
}
#footer {
	padding: 10px 20px;
	background: rgb(51, 51, 51);
	color: white;
	font-size: 14px;
	line-height: 1.5em;
	min-height: 40px;
	display: flex;
	justify-content: space-between;
}
#footer_left {
	flex: 1;
}
#footer_right {
	text-align: right;
}
</style>
<script src="glue.js"></script>
<script src="divs.js"></script>
</head>

<body id=main>
<img id=logo src=logo.png>
<div id=product_viewport>
	<div id=product_list>
		<img class=product_image src=1.png>
		<img class=product_image src=2.png>
		<img class=product_image src=3.png>
	</div>
</div>
<div id=cart_viewport class=order_bar>
	<div id=cart_list>
	</div>
</div>
<div id=order_bar class=order_bar>
	<div id=totals>
		<div class=total>Total</div>
		<div class=total id=total>120</div>
		<div class=discount>Discount</div>
		<div class=discount id=discount>120</div>
	</div>
	<div id=order_btn>COMANDA</div>
</div>
<div id=footer>
	<div id=footer_left>
		<div>Events / Corporate</div>
		<div>Contact</div>
	</div>
	<div id=footer_right>
		<img src=facebook.png style="width: 50%">
	</div>
</div>
<script>

p = [
	{
		title: 'Box o\'donuts',
		id: 1,
	},
	{
		title: 'Sweet donut',
		id: 2,
	},
	{
		title: 'Even sweeter',
		id: 3,
	},
]

// product image fit container height ----------------------------------------

view_w = null
view_h = null

function get_product_viewport_size() {
	view_w = product_viewport.clientWidth
	view_h = product_viewport.clientHeight
}

function resize_product_image(p) {
	let w0 = p.naturalWidth
	let h0 = p.naturalHeight
	p.h = min(view_w, view_h)
	p.w = min(view_w, view_h)
	p.style.display = 'flex'
	select_product(selected_product_index)
}
function product_image_loaded(ev) {
	resize_product_image(this)
}
for (let p of product_list.children)
	p.onload = product_image_loaded

document.on('layout_changed', function() {
	for (let p of product_list.children)
		p.hide()
	get_product_viewport_size()
	for (let p of product_list.children)
		resize_product_image(p)
})

// product selection ---------------------------------------------------------

selected_product_index = 0

function select_product(index) {
	index = clamp(index, 0, product_list.at.length - 1)
	selected_product_index = index
	let x = 0
	for (let i = 0; i < index; i++) {
		let p = product_list.at[i]
		x += p.offsetWidth
	}
	product_list.x = -x
		- product_list.at[index].offsetWidth / 2
		+ product_viewport.clientWidth / 2
}

document.on('keydown', function(key) {
	if (key == 'ArrowLeft' || key == 'ArrowRight') {
		select_product(selected_product_index += (key == 'ArrowLeft' ? -1 : 1))
		return false
	}
})

product_viewport.on('pointerdown', function(ev, mx, my) {

	let x0 = product_list.offsetLeft
	let dx = mx - this.client_rect().x - x0

	function pointermove(mx, my) {
		mx -= this.client_rect().x
		product_list.x = mx - dx
		return false
	}

	function pointerup() {
		product_list.class('swiping', false)
		let dx = x0 - product_list.offsetLeft
		if (abs(dx) <= 10) {
			select_product(selected_product_index)
			add_to_cart()
		} else {
			let i = selected_product_index + (dx < 0 ? -1 : 1)
			select_product(i)
		}
		return false
	}

	product_list.class('swiping', true)

	return this.capture_pointer(ev, pointermove, pointerup)
})

// cart page selection -------------------------------------------------------

selected_cart_page_index = 0

function select_cart_page(index) {
	return
	index = clamp(index, 0, product_list.at.length - 1)
	selected_cart_page_index = index
	let x = 0
	for (let i = 0; i < index; i++) {
		let p = product_list.at[i]
		x += p.offsetWidth
	}
	cart_list.x = -x
		- cart_list.at[index].offsetWidth / 2
		+ cart_list.clientWidth / 2
}

cart_viewport.on('pointerdown', function(ev, mx, my) {

	let cart_img = ev.target
	if (cart_img.product_index == null)
		return

	let x0 = cart_list.offsetLeft
	let dx = mx - this.client_rect().x - x0

	function pointermove(mx, my) {
		mx -= this.client_rect().x
		cart_list.x = mx - dx
		return false
	}

	function pointerup(mx, my, ev) {
		cart_list.class('swiping', false)
		let dx = x0 - cart_list.offsetLeft
		if (abs(dx) <= 10) {
			select_cart_page(selected_cart_page_index)
			remove_from_cart(cart_img)
		} else {
			let i = selected_cart_page_index + (dx < 0 ? -1 : 1)
			select_cart_page(i)
		}
		return false
	}
	cart_list.class('swiping', true)

	return this.capture_pointer(ev, pointermove, pointerup)
})

// cart operations -----------------------------------------------------------

cart = []

function add_to_cart() {

	let prod_img = product_list.at[selected_product_index]
	let aspect_ratio = prod_img.naturalWidth / prod_img.naturalHeight

	let cart_img = H.img({
		class: 'product_image_cart',
		src: prod_img.attr('src'),
		style: 'visibility: hidden',
	})
	cart_img.product_index = prod_img.index
	cart_img.w = 50 * aspect_ratio
	cart_list.add(cart_img)
	cart.push(prod_img.index)

	let cr = cart_img.client_rect()
	let pr = prod_img.client_rect()
	let mr = main.client_rect()

	let move_img = prod_img.cloneNode()
	move_img.classes = 'move_to_cart'
	move_img.style.left = (pr.x - mr.x)+'px'
	move_img.style.top  = (pr.y - mr.y)+'px'
	main.add(move_img)

	after(.4, function() {
		move_img.remove()
		cart_img.style.visibility = null
	})

	after(0.01, function() {
		move_img.classes = 'move_to_cart_moving'
		move_img.style.left   = (cr.x - mr.x)+'px'
		move_img.style.top    = (cr.y - mr.y)+'px'
		move_img.style.width  = (cr.w)+'px'
		move_img.style.height = (cr.h)+'px'
	})

}

function remove_from_cart(cart_img) {
	cart_img.style.top = '-20px'
	cart_img.w = 0
	cart_img.style.opacity = 0
	after(.4, function() {
		cart_img.remove()
	})
}

// init ----------------------------------------------------------------------

window.onload = function() {
	document.fire('layout_changed')
}

</script>
</body>
</html>
